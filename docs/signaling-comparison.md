# WebRTC シグナリング方式 比較資料

## 概要

WebRTCでP2P通信を確立するためには、接続情報（SDP）とネットワーク情報（ICE候補）を交換する「シグナリング」が必要です。この資料では、3つの主要なアプローチを比較します。

---

## 方式一覧

| 方式 | 例 | 概要 |
|------|-----|------|
| 完全サーバーレス | 手動SDP交換 | 接続情報を手動でコピー＆ペースト |
| BaaS利用 | Firebase, Supabase, Google Spreadsheet | 外部サービスでシグナリングを代替 |
| 自前サーバー | Socket.io, WebSocket | 専用サーバーでシグナリングを処理 |

---

## 詳細比較

### 1. 完全サーバーレス（手動SDP交換）

#### シーケンス図

```
┌─────────┐                              ┌─────────┐
│ User A  │                              │ User B  │
└────┬────┘                              └────┬────┘
     │                                        │
     │  1. SDPオファー生成                     │
     │ ─────────────────────────────────────> │
     │    (LINE, メール等で送信)               │
     │                                        │
     │  2. SDPアンサー生成                     │
     │ <───────────────────────────────────── │
     │    (LINE, メール等で返信)               │
     │                                        │
     │  3. ICE候補交換（双方向）               │
     │ <────────────────────────────────────> │
     │                                        │
     │═══════════ P2P接続確立 ═══════════════│
     │                                        │
```

#### メリット

- **コストゼロ**: サーバー費用が一切かからない
- **外部依存なし**: 外部サービスの障害に影響されない
- **プライバシー**: 中間サーバーにデータが保存されない
- **シンプル**: 実装が比較的容易

#### デメリット

- **UX低下**: 長いテキストをコピー＆ペーストする必要がある
- **マッチング不可**: 「待機中の島」のような機能は実装不可能
- **技術知識必要**: ユーザーがある程度操作を理解する必要がある
- **エラー発生しやすい**: テキストのコピーミスで接続失敗

#### 適したユースケース

- 開発・テスト用途
- 技術者同士の1対1通話
- 完全プライベートな通信

---

### 2. BaaS利用（Firebase / Google Spreadsheet）

#### シーケンス図（Firebase）

```
┌─────────┐           ┌──────────┐           ┌─────────┐
│ User A  │           │ Firebase │           │ User B  │
└────┬────┘           └────┬─────┘           └────┬────┘
     │                     │                      │
     │  1. 島に入室         │                      │
     │ ──────────────────> │                      │
     │                     │                      │
     │                     │  2. 島に入室          │
     │                     │ <──────────────────── │
     │                     │                      │
     │  3. Battle作成通知   │                      │
     │ <────────────────── │ ───────────────────> │
     │                     │                      │
     │  4. SDPオファー      │                      │
     │ ──────────────────> │ ───────────────────> │
     │                     │                      │
     │                     │  5. SDPアンサー       │
     │ <────────────────── │ <──────────────────── │
     │                     │                      │
     │  6. ICE候補交換      │                      │
     │ <────────────────> │ <────────────────────> │
     │                     │                      │
     │═════════════════ P2P接続確立 ══════════════│
     │                     │                      │
```

#### Firebase

| 項目 | 内容 |
|------|------|
| **月額費用** | 無料（Sparkプラン）〜 従量課金 |
| **無料枠** | 50,000読み取り/日、20,000書き込み/日 |
| **リアルタイム** | onSnapshot でリアルタイム同期 |
| **信頼性** | 99.95% SLA（Google基盤） |
| **セットアップ** | Firebaseプロジェクト作成が必要 |

#### Google Spreadsheet（Apps Script）

| 項目 | 内容 |
|------|------|
| **月額費用** | 無料 |
| **制限** | 6分/実行、100MB/日のURL Fetch |
| **リアルタイム** | ポーリングで代替（5秒間隔等） |
| **信頼性** | Google基盤 |
| **セットアップ** | SpreadsheetとApps Script作成 |

#### メリット

- **自前サーバー不要**: インフラ管理の負担なし
- **無料枠で運用可能**: 小規模利用なら完全無料
- **マッチング機能**: 「島」の状態共有が可能
- **良好なUX**: 自動接続で使いやすい
- **スケーラブル**: 利用増に応じて自動スケール

#### デメリット

- **外部サービス依存**: サービス障害時は利用不可
- **大規模時は課金**: アクセス増で費用発生
- **カスタマイズ限界**: 細かい制御に制限

#### 適したユースケース

- 小〜中規模のカジュアルアプリ
- プロトタイプ・MVP開発
- 個人/小チームのプロジェクト

---

### 3. 自前シグナリングサーバー（Socket.io / WebSocket）

#### シーケンス図

```
┌─────────┐           ┌──────────┐           ┌─────────┐
│ User A  │           │  Server  │           │ User B  │
└────┬────┘           └────┬─────┘           └────┬────┘
     │                     │                      │
     │  1. WebSocket接続    │                      │
     │ ──────────────────> │ <──────────────────── │
     │                     │                      │
     │  2. ルーム参加       │                      │
     │ ──────────────────> │ ───────────────────> │
     │                     │                      │
     │  3. SDPオファー      │                      │
     │ ──────────────────> │ ───────────────────> │
     │                     │                      │
     │                     │  4. SDPアンサー       │
     │ <────────────────── │ <──────────────────── │
     │                     │                      │
     │  5. ICE候補（リレー）  │                      │
     │ <────────────────> │ <────────────────────> │
     │                     │                      │
     │═════════════════ P2P接続確立 ══════════════│
     │                     │                      │
```

#### メリット

- **完全な制御**: すべての動作をカスタマイズ可能
- **低レイテンシ**: WebSocket常時接続で即座に通信
- **外部依存なし**: 自社管理で可用性コントロール
- **機能追加容易**: 認証、ロギング、統計等を自由に追加
- **大規模対応**: 負荷分散、クラスタリング可能

#### デメリット

- **サーバー費用**: 月額$5〜50+（規模による）
- **運用負担**: 監視、更新、バックアップが必要
- **実装難易度高**: 専門知識が必要
- **スケーリング設計**: 自前で設計・実装が必要

#### 適したユースケース

- 商用サービス
- 大規模ユーザー基盤
- 高度なカスタマイズが必要な場合

---

## 総合比較表

| 項目 | 手動SDP交換 | Firebase | Spreadsheet | 自前サーバー |
|------|-------------|----------|-------------|--------------|
| **初期コスト** | 無料 | 無料 | 無料 | $5〜50+/月 |
| **運用コスト** | 無料 | 無料〜従量課金 | 無料 | $5〜50+/月 |
| **セットアップ難易度** | ★☆☆ | ★★☆ | ★★☆ | ★★★ |
| **リアルタイム性** | N/A | ★★★ | ★★☆ | ★★★ |
| **マッチング機能** | 不可 | 可能 | 可能 | 可能 |
| **スケーラビリティ** | N/A | 自動 | 制限あり | 設計次第 |
| **カスタマイズ性** | ★☆☆ | ★★☆ | ★★☆ | ★★★ |
| **UX** | ★☆☆ | ★★★ | ★★☆ | ★★★ |
| **外部依存** | なし | Google | Google | なし |

---

## 推奨フローチャート

```
┌─────────────────────────────────────┐
│       WebRTCアプリを開発したい        │
└───────────────┬─────────────────────┘
                │
                ▼
        ┌───────────────┐
        │ マッチング機能  │
        │   が必要？     │
        └───────┬───────┘
           YES  │   NO
        ┌───────┴───────┐
        │               │
        ▼               ▼
┌───────────────┐  ┌───────────────┐
│ ユーザー規模は │  │  手動SDP交換  │
│   大規模？    │  │   で十分     │
└───────┬───────┘  └───────────────┘
   YES  │   NO
┌───────┴───────┐
│               │
▼               ▼
┌───────────────┐  ┌───────────────┐
│  自前サーバー  │  │ BaaS利用      │
│  を構築       │  │ (Firebase等)  │
└───────────────┘  └───────────────┘
```

---

## 本プロジェクトでの選択

### Firebase版（webrtc_front）

**理由:**
1. マッチング機能（島）が必要
2. 小規模利用で無料枠で十分
3. リアルタイム同期が容易
4. 運用負担が最小限

### Google Spreadsheet版（webrtc_spreadsheet）

**理由:**
1. Firebaseアカウント不要
2. より軽量な代替手段
3. スプレッドシートで状態を直接確認可能
4. 完全無料

---

## 参考リンク

- [WebRTC公式ドキュメント](https://webrtc.org/)
- [Firebase Firestore](https://firebase.google.com/docs/firestore)
- [Google Apps Script](https://developers.google.com/apps-script)
- [Socket.io](https://socket.io/)
